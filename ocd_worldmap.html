<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sankey Diagram</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://unpkg.com/d3-sankey"></script>
    <style>
         body {
            font-family: "Arial", sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        header, footer {
            background-color: #beed9e;
            padding: 10px 20px;
            text-align: center;
        }
        svg {
            display: block;
            margin: auto;
            background-color: #f9f9f9;
        }
        .node rect {
            cursor: move;
            stroke-width: 2px;
        }
        .link {
            stroke: #000;
            stroke-opacity: 0.2;
        }
        .link-gradient {
            stroke-opacity: 0.5;
        }
        #sankey_tooltip {
            position: absolute;
            text-align: center;
            width: 200px;
            padding: 10px;
            font-size: 14px;
            background: white;
            border: 1px solid #d3d3d3;
            pointer-events: none;
            opacity: 0;
        }
    </style>
</head>
<body>
    <header>
        <h1>Interactive Sankey Diagram</h1>
    </header>
    <div id="sankey"></div>
    <div id="sankey_tooltip"></div>
    <footer>
        <p>Copyright Â© 2024 by Your Company or Project Name. All rights reserved.</p>
    </footer>
    <script>
        function sankey() {
            var w = 1450;
            var h = 800;
            var padding = 30;
            
            const schemeCategory10 = d3.schemeTableau10;
            const schemeTableau10 = d3.schemeAccent;

            const combinedColors = schemeCategory10.concat(schemeTableau10);
            var color = d3
                .scaleOrdinal(d3.schemeTableau10)
                .domain(d3.range(combinedColors.length))
                .range(combinedColors);

            const createGradientId = (link) => {
                return `gradient-${link.source.node}-${link.target.node}`;
            };

            var svg = d3
                .select("#sankey")
                .append("svg")
                .attr("width", w)
                .attr("height", h)
                .attr("style", "border: 1px solid;");

            var g = svg
                .append("g")
                .attr("transform", `translate(${padding},${padding})`);

            svg.call(
                d3.zoom()
                    .scaleExtent([1, 3])
                    .on("zoom", (event) => {
                        g.attr("transform", event.transform);
                    })
            );

            var sankey = d3.sankey()
                .nodeWidth(36)
                .nodePadding(40)
                .size([w - padding * 2, h - padding * 2]);

            d3.json("sankey.json").then((data) => {
                data.links.forEach((link) => {
                    link.sign = Math.sign(link.value);
                    link.value = Math.abs(parseInt(link.value));
                });
                graph = sankey(data);
                

                // Create and apply gradients dynamically
var link = g.append("g")
    .attr("fill", "none")
    .selectAll("link")
    .data(graph.links)
    .enter()
    .append("path")
    .attr("class", "link")
    .attr("d", d3.sankeyLinkHorizontal())
    .attr("stroke-width", (d) => Math.max(1, d.width))
    .style("stroke", function(d, i) {
        // Create unique gradient ids
        const gradientId = `gradient-${i}`;

        // Append gradient to the defs block
        const linearGradient = svg.append("defs")
          .append("linearGradient")
            .attr("id", gradientId)
            .attr("gradientUnits", "userSpaceOnUse")
            .attr("x1", d.source.x1)
            .attr("x2", d.target.x0);

        // Define the start and stop colors
        linearGradient.append("stop")
            .attr("offset", "0%")
            .attr("stop-color", color(d.source.name));

        linearGradient.append("stop")
            .attr("offset", "100%")
            .attr("stop-color", color(d.target.name));

        // Use gradient URL for the stroke
        return `url(#${gradientId})`;
    })
    .on("mouseover", function (event, d) {
        const tooltipText = [
            "Country: " + d.source.name,
            "State: " + d.target.name,
            "Net Overseas Migration: " + d.value * d.sign,
        ].join("<br/>");
        ShowSankeyTooltip(event, tooltipText);
    })
    .on("mouseleave", HideSankeyTooltip);

// Function to update gradient positions on drag or zoom
function updateGradients() {
    svg.selectAll("linearGradient")
        .attr("x1", (d) => d.source.x1)
        .attr("x2", (d) => d.target.x0);
}

// Add this to zoom and drag handlers
d3.zoom().on("zoom", (event) => {
    g.attr("transform", event.transform);
    updateGradients();  // Update gradients on zoom
});

d3.drag().on("drag", (event, d) => {
    updateGradients();  // Update gradients on node drag
});


                link.each(function (d, i) {
                    const gradientId = createGradientId(d);

                    const gradient = svg
                        .append("linearGradient")
                        .attr("id", gradientId)
                        .attr("gradientUnits", "userSpaceOnUse")
                        .attr("x1", d.source.x1)
                        .attr("x2", d.target.x0);
                        

                    gradient
                        .append("stop")
                        .attr("offset", "0%")
                        .attr("stop-color", color(d.source.name));

                    gradient
                        .append("stop")
                        .attr("offset", "100%")
                        .attr("stop-color", color(d.target.name));

                    d3.select(this)
                        .attr("stroke", `url(#${gradientId})`)
                        .classed("link-gradient", true);
                });

                var node = g.append("g")
                    .selectAll(".node")
                    .data(graph.nodes)
                    .enter()
                    .append("g")
                    .attr("class", "node")
                    .call(
                        d3.drag()
                            .subject((d) => d)
                            .on("start", function() { this.parentNode.appendChild(this); })
                            .on("drag", movenode)
                    );

                node
                    .append("rect")
                    .attr("x", (d) => d.x0)
                    .attr("y", (d) => d.y0)
                    .attr("height", function (d) {
                    d.rectHeight = d.y1 - d.y0;   // height of the node
                      return d.y1 - d.y0;
                    })
      .attr("width", sankey.nodeWidth()) // width of the node
      .style("fill", (d) => (d.color = color(d.name)))
      .attr("stroke", "#000")
      .append("title");

                node.append("text")
                    .attr("x", (d) => d.x0 - 5)
                    .attr("y", (d) => (d.y1 + d.y0) / 2)
                    .attr("dy", "0.3em")
                    .attr("text-anchor", "end")
                    .text((d) => d.name)
                    .filter((d) => d.x0 < w / 2)
                    .attr("x", (d) => d.x1 + 5)
                    .attr("text-anchor", "start");

                function movenode(d) {
                    d3.select(this).select("rect").attr("y", (m) => {
                        m.y0 = Math.max(0, Math.min(m.y0 + d.dy, h - (m.y1 - m.y0)));
                        m.y1 = m.y0 + (m.y1 - m.y0);
                        return m.y0;
                    });

                    d3.select(this).select("text").attr("y", (m) => (m.y0 + m.y1) / 2);
                    sankey.update(graph);
                    link.attr("d", d3.sankeyLinkHorizontal());
                }
            });
        }

        function ShowSankeyTooltip(event, text) {
            var tooltip = d3.select("#sankey_tooltip");
            var [x, y] = d3.pointer(event);
            tooltip.transition().duration(200).style("opacity", 1);
            tooltip.html(text).style("left", x + "px").style("top", y + "px");
        }

        function HideSankeyTooltip() {
            var tooltip = d3.select("#sankey_tooltip");
            tooltip.transition().duration(200).style("opacity", 0);
        }

        sankey();
    </script>
</body>
</html>
